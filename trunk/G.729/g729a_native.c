#include <stdlib.h>
#include <inttypes.h>
#include <math.h>

#define VECTOR_SIZE 15
#define MA_NP 4

#define FFSWAP(type,a,b) do{type SWAP_tmp= b; b= a; a= SWAP_tmp;}while(0)
#define FFMAX(a,b) ((a) > (b) ? (a) : (b))
#define FFMIN(a,b) ((a) > (b) ? (b) : (a))

typedef struct
{
    short* exc_base;
    short* exc;
    int *lq_prev[MA_NP]; ///< l[i], LSP quantizer output (3.2.4)
    int lsp_prev[10];    ///< q[i], LSP coefficients from previous frame (3.2.5)
    float betta;         ///< betta, Pitch gain (3.8)
    float g[40];         ///< gain coefficient (4.2.4)
    int rand_seed;       ///< seed for random number generator (4.4.4)
    int prev_mode;
}  G729A_Context;

/**
 * Fixed-point L1 codebook (10-dimensional, with 128 entries (3.2.4)
 */
static const int32_t cb_L1[128][10] = {        /* Q15 */
{  5944,   8672,  15004,  36296,  48536,  55776,  71932,  76692,  84760,  87280},
{  6920,  10560,  13800,  19480,  24504,  31504,  62576,  71268,  81176,  87608},
{  6272,   9024,  12352,  19496,  44252,  53572,  73228,  77172,  84436,  86964},
{  6932,  10048,  13428,  18832,  27908,  41184,  68096,  71824,  76580,  81400},
{  6976,   9744,  13232,  34924,  41728,  48028,  62456,  66556,  85436,  87652},
{  7144,   9476,  13488,  18084,  27180,  51852,  70696,  75952,  83420,  86560},
{  6524,   9732,  13444,  25312,  42836,  48052,  53108,  55616,  77764,  84352},
{  5956,   9456,  13164,  25000,  36908,  41612,  55372,  61112,  70884,  85804},
{  7476,  10132,  13900,  17460,  36608,  58052,  63632,  68088,  82444,  85644},
{  8280,  12100,  17332,  23416,  31220,  36924,  42388,  64188,  80436,  87336},
{  7640,  10692,  13676,  17044,  44672,  60444,  66308,  70364,  77240,  81060},
{  4564,   7260,  10496,  18492,  25980,  38352,  55872,  65712,  77404,  85144},
{  8768,  12684,  18828,  23232,  43616,  50000,  56648,  62656,  84496,  87156},
{  5144,   7628,  10192,  13812,  38296,  47856,  63912,  69376,  78764,  89980},
{  7684,  10880,  18416,  26736,  46012,  51968,  57400,  61048,  67988,  83164},
{  8208,  11036,  15588,  20984,  26552,  41068,  63336,  67256,  72596,  86700},
{  7192,   9988,  22468,  45796,  52756,  58844,  68200,  72780,  81228,  84728},
{  4036,   6588,  11556,  22836,  38164,  49416,  60924,  73976,  83864,  88132},
{ 12064,  15176,  21624,  29876,  49952,  55936,  61312,  65336,  79808,  83164},
{  8812,  12160,  15184,  21768,  47948,  54048,  59724,  65480,  71424,  75212},
{ 11648,  17168,  31952,  38288,  46248,  52976,  58224,  66116,  80016,  84292},
{ 11444,  14428,  23692,  28136,  36936,  48216,  54916,  72224,  81048,  83896},
{ 12276,  17244,  23868,  29468,  45928,  50796,  57236,  64932,  73332,  76688},
{  9736,  14644,  19464,  23192,  41532,  46888,  52196,  62672,  75448,  79324},
{  8080,  10420,  15440,  36964,  53100,  58576,  64040,  68396,  77072,  81004},
{  7508,  11236,  14360,  18828,  44224,  49764,  62488,  68672,  75044,  79628},
{  8428,  11492,  14692,  23196,  54316,  58748,  63752,  68308,  75560,  79324},
{  6448,   9136,  11776,  14288,  32876,  55836,  63696,  68956,  74368,  80468},
{  9680,  12624,  26168,  40860,  48244,  54136,  61220,  65808,  74868,  79520},
{  6668,  10448,  14136,  20948,  42052,  46784,  51760,  67192,  72232,  77512},
{  9552,  12068,  19356,  37332,  45652,  50920,  60096,  64992,  69796,  74708},
{  7500,  11144,  16924,  25280,  34776,  40596,  47140,  68052,  74432,  79840},
{  2716,   5644,  18616,  32024,  45784,  52996,  63052,  72508,  81444,  86268},
{  7352,  10384,  14312,  18432,  22600,  45096,  57420,  63544,  82316,  87016},
{  5212,   7820,   9580,  13288,  48092,  55056,  63532,  72308,  80720,  84928},
{  5752,   8408,  10652,  13848,  33312,  41448,  55052,  68992,  78928,  89376},
{  3440,   7616,  24392,  31100,  39260,  48028,  59284,  66836,  79148,  84528},
{  6692,  10892,  14816,  24500,  30672,  37788,  54732,  57772,  82152,  86924},
{  4984,   7396,  11608,  18032,  28884,  50840,  59340,  65256,  77340,  90880},
{  6100,   9040,  15448,  22636,  29368,  46992,  53480,  57768,  72176,  85336},
{  4784,   7384,  12416,  28252,  43888,  51620,  59256,  68148,  79688,  90544},
{  8588,  12424,  17900,  26044,  32908,  39060,  43936,  48644,  75884,  85200},
{  6340,   9620,  11976,  16144,  45924,  52708,  58076,  61724,  79868,  85100},
{  7112,  10752,  14456,  18720,  37860,  44256,  49892,  65280,  78968,  83200},
{  7448,  10344,  13968,  26876,  46832,  52048,  57456,  64512,  78440,  81700},
{  5580,   8624,  10676,  13544,  42428,  48500,  54456,  66820,  75904,  85468},
{  5776,   8468,  13144,  24932,  37692,  51924,  59992,  63412,  68752,  87428},
{  8016,  11580,  15132,  19588,  24672,  29188,  50436,  65780,  77188,  85860},
{  5980,  11452,  25440,  32400,  45596,  57084,  63608,  70844,  81916,  88244},
{  9936,  12456,  22872,  28388,  33600,  50464,  56292,  59388,  82140,  85584},
{  9696,  13108,  21184,  25136,  45160,  51612,  64088,  70032,  77332,  81132},
{ 10260,  15112,  21440,  27956,  35128,  41712,  57560,  62968,  71080,  86936},
{ 10908,  13536,  26452,  37016,  42168,  48944,  58604,  62748,  80296,  84408},
{  7664,  11812,  25096,  32352,  38840,  43700,  49568,  65736,  80040,  84732},
{ 13536,  17464,  21396,  30668,  44720,  50420,  55684,  61296,  79604,  83016},
{ 12300,  17132,  23804,  30476,  38416,  44040,  49536,  56024,  82632,  85988},
{  7004,   9820,  20588,  39864,  46484,  52704,  58956,  65880,  83152,  87024},
{  5768,   8752,  13320,  27252,  35716,  48540,  57904,  61224,  78540,  82176},
{  9176,  11580,  16280,  32140,  48932,  53664,  59048,  69468,  75808,  78752},
{  7748,  10636,  18408,  26788,  36284,  51452,  56788,  60920,  64188,  75508},
{  8284,  10652,  16864,  37780,  43548,  49168,  55796,  59636,  76944,  81364},
{  6960,   9964,  13952,  32552,  38624,  44612,  52824,  58752,  83584,  87628},
{  8796,  11524,  18700,  34108,  40204,  45632,  57740,  61852,  68760,  82388},
{  7772,  11952,  16708,  24156,  29912,  34144,  56724,  62204,  70488,  86316},
{  7300,  12700,  28248,  39272,  51296,  61800,  73320,  79424,  87320,  89648},
{  9856,  12184,  19288,  23908,  30784,  61592,  66920,  70584,  82352,  85280},
{ 10200,  13572,  21220,  27680,  40940,  56332,  72572,  76780,  82724,  85344},
{ 12012,  15196,  21284,  25748,  31676,  46572,  63240,  67384,  72476,  75920},
{ 13820,  16628,  27352,  32796,  39508,  49256,  63620,  67304,  79796,  83568},
{ 12208,  15076,  19564,  23240,  27908,  40504,  59152,  63960,  79092,  83616},
{ 14684,  17424,  23308,  27988,  33840,  48336,  56616,  59756,  76988,  81692},
{ 10864,  14736,  20984,  26744,  33852,  40004,  49576,  56524,  64600,  79104},
{  7780,  10552,  16520,  31980,  57352,  62304,  68228,  72824,  80900,  83988},
{  9216,  11712,  16488,  19296,  22560,  52556,  63300,  67752,  80432,  84216},
{  7200,  10064,  13400,  20876,  53624,  63792,  70472,  74160,  82124,  85008},
{  5744,   8896,  11012,  18184,  38628,  44980,  60708,  65268,  69956,  76540},
{  9276,  11596,  19920,  27744,  33616,  53956,  62216,  65124,  81080,  83644},
{  8748,  11676,  18440,  23500,  29560,  50224,  56132,  67176,  83992,  87076},
{  8940,  11692,  20484,  25036,  32396,  54356,  61360,  65360,  71708,  80636},
{  7060,  10552,  15004,  22920,  31532,  40432,  54532,  61676,  67232,  74296},
{ 13840,  22964,  38384,  46968,  57652,  64320,  72692,  76360,  83380,  86404},
{ 14940,  17704,  24796,  29452,  37000,  57956,  64140,  68104,  79492,  83504},
{ 14084,  19112,  27548,  34720,  50868,  57288,  63800,  72200,  80664,  84580},
{  8564,  11872,  27460,  32204,  40040,  52636,  59252,  63444,  70112,  74620},
{ 16592,  24512,  36112,  43484,  50744,  56020,  63904,  68832,  78348,  82380},
{ 17612,  21468,  26536,  33484,  40652,  46396,  59852,  65324,  71928,  75072},
{ 16364,  21544,  27408,  35080,  46252,  53160,  62912,  67720,  76224,  80408},
{ 10984,  14500,  21196,  30016,  41048,  45728,  52688,  61960,  67500,  70056},
{  8992,  14224,  34156,  42360,  50660,  58784,  66060,  71296,  81072,  84988},
{  5116,   7840,  15680,  31172,  40612,  59012,  66584,  72556,  82716,  85864},
{  9760,  13900,  26948,  34616,  48760,  58352,  68476,  71700,  76440,  79916},
{  7516,  10056,  17988,  30288,  40068,  59792,  64564,  67588,  73588,  77504},
{ 11216,  14752,  29960,  40344,  44872,  50844,  65228,  69880,  80308,  84504},
{  8092,  10728,  15492,  33072,  41020,  46580,  60748,  68408,  75860,  79152},
{ 11292,  14420,  23260,  34380,  40340,  45876,  66272,  69848,  75016,  79504},
{ 11404,  14724,  21120,  30592,  36692,  41352,  59844,  64592,  70236,  73896},
{  5392,  10580,  23304,  35140,  42480,  51324,  65020,  73276,  84532,  90344},
{  8564,  12144,  17172,  24328,  30372,  42516,  68632,  72132,  85864,  88336},
{  6432,   9500,  13536,  27512,  39880,  44908,  67712,  70600,  80740,  84480},
{ 11096,  14464,  20056,  26228,  31152,  35836,  68272,  73208,  78148,  82168},
{  7736,  19252,  24816,  28848,  35916,  46660,  63956,  71244,  81704,  86812},
{  9152,  14028,  20148,  27364,  33112,  38552,  60264,  65924,  86612,  88856},
{ 11804,  15084,  19512,  30312,  36064,  41192,  57960,  60968,  80892,  83960},
{ 13024,  19164,  26404,  30084,  34576,  38828,  53592,  64312,  76408,  80996},
{  7308,  10456,  13944,  24156,  48596,  55292,  64764,  69128,  85692,  88164},
{  4000,   6816,  12008,  25340,  33884,  42000,  59512,  67916,  80104,  89708},
{  6584,   9144,  12436,  28980,  45972,  51164,  67296,  70668,  75924,  80888},
{  6832,  10004,  13260,  26948,  34916,  39696,  64356,  68388,  73496,  79668},
{ 10492,  14040,  17912,  22580,  39448,  44460,  60876,  72268,  78332,  81528},
{ 10072,  13736,  18912,  25552,  32328,  37140,  52648,  73532,  79276,  82208},
{  6904,   9532,  16360,  25212,  31220,  51380,  58448,  70432,  77076,  80724},
{ 11440,  14940,  19352,  24176,  29016,  33608,  56124,  65524,  72148,  77640},
{ 16988,  23972,  31808,  39168,  49368,  58612,  70108,  75096,  83324,  86796},
{ 14008,  16204,  22720,  27220,  32584,  47780,  66596,  69776,  81560,  86256},
{ 12604,  19572,  23596,  28792,  45672,  52292,  60496,  70692,  82080,  87444},
{ 15840,  19392,  23704,  29036,  35244,  42116,  62644,  66240,  72784,  80732},
{ 17996,  26416,  32144,  37004,  43216,  50508,  63520,  70048,  80080,  84184},
{ 17004,  22164,  26616,  33272,  39600,  46744,  60400,  68372,  82288,  86748},
{ 15076,  21308,  31460,  37440,  42736,  47272,  54640,  61464,  74932,  79528},
{ 12332,  15876,  24992,  32484,  39192,  43976,  49572,  54744,  71552,  76420},
{ 10924,  18680,  28252,  36804,  45384,  54940,  67500,  75188,  83148,  89440},
{  4748,   8908,  18948,  28856,  38488,  50532,  61616,  71872,  81048,  94132},
{  7644,   9908,  15660,  40392,  46464,  51820,  64892,  68552,  77080,  82916},
{  7056,  10076,  15548,  27776,  36600,  50360,  65032,  67936,  71696,  73740},
{  5600,  14696,  28524,  34872,  42752,  50032,  62832,  70844,  78880,  84272},
{  9288,  12292,  17148,  32432,  37628,  42512,  63448,  66772,  78856,  85896},
{ 10520,  13356,  19032,  33440,  41096,  45332,  51520,  69496,  76884,  79744},
{  6884,  10308,  22212,  28780,  34604,  42744,  60276,  67812,  74812,  79716},
};

/**
 * Fixed-point L2 codebook (10-dimensional, with 32 entries (3.2.4)
 */
static const int32_t cb_L2[32][5] = {        /* Q15 */
{ -1740,  -3260,  -2968,   4132,  -2072},
{ -3332,  -3564,   1852,    -32,  -5004},
{ -4084,    924,  -1224,   1284,   -880},
{   228,   -792,  -1356,   -132,  -5872},
{   684,  -1400,   1176,   6640,   1812},
{ -2804,  -3368,   -232,   3800,   3568},
{  2336,    124,  -1156,   1424,  -1332},
{  -436,  -3232,    924,    308,   -348},
{ -3436,   4944,   2200,   3416,   2856},
{ -3508,  -3816,  -4992,  -1196,    848},
{  -308,   1376,  -2480,   3052,   1652},
{ -1256,  -1228,  -1024,  -5040,  -1716},
{  2844,   2772,   2084,   2600,   5220},
{  -448,  -1084,  -2000,   3784,   6932},
{  2300,    -40,  -1872,   -796,   4404},
{   580,  -1140,  -5120,  -1592,    144},
{ -4532,  -3340,   5400,   5136,   -380},
{ -5836,  -4948,   1664,   -852,   1864},
{   -60,    264,   1872,   4076,  -2992},
{ -1352,    592,   5780,    300,  -3040},
{  1556,    956,   6272,   3924,    452},
{ -1248,   -392,   3796,    124,   4416},
{  4508,   2336,   3340,   1108,  -4636},
{  2156,   -456,   3424,  -1972,    892},
{  8788,   9348,   5072,   2680,   1216},
{ -6384,   2200,   3204,  -1824,   -224},
{  4616,   2372,   -308,   4948,   -124},
{  1588,   2232,    812,  -3188,  -3676},
{  1336,   5900,   2528,   -320,    192},
{ -2180,  -1320,  -1716,  -2720,   4532},
{  5280,   3308,  -1592,  -2304,   1364},
{  -652,   2696,    -44,  -3544,   2124},
};

/**
 * Fixed-point L3 codebook (10-dimensional, with 32 entries (3.2.4)
 */
static const int32_t cb_L3[32][5] = {        /* Q15 */
{  2328,  -4804,   3316,    344,   1540},
{  5800,    288,   -924,   3456,   2644},
{  -652,  -2104,  -3016,  -6532,   1068},
{  2292,   3184,   -676,  -2524,   3264},
{  2076,   1164,    636,  -2560,  -5184},
{  6196,   2860,   2108,  -2856,   -772},
{ -1828,   2448,  -1132,  -5524,  -2964},
{ -1376,   5364,   4348,  -2616,  -2276},
{ -2172,  -7008,   -780,   -392,  -1104},
{  -940,  -2912,   3796,   6068,   3580},
{  2008,  -1448,  -3840,  -1932,   5544},
{  1800,  -1864,   -432,   4040,   8892},
{  -112,  -1512,   2976,  -4020,    960},
{  1084,    -60,   3636,  -1036,   6752},
{ -4044,   2324,   -212,  -2988,   3512},
{ -1992,  -5508,     72,  -1776,   5932},
{  4060,   -888,   1772,   1488,  -1416},
{  2676,   2636,   6560,   3728,   2136},
{  5540,   -728,  -3628,  -2884,  -1048},
{  2276,   4988,   1348,   1664,   -484},
{  1476,  -4012,  -2028,  -2348,  -3616},
{   288,   -564,   5860,    252,  -3140},
{   832,   1204,  -3528,    468,  -1616},
{ -3648,   2492,   -304,   1104,  -1760},
{ -1068,  -2100,    560,   3528,   -556},
{ -2788,   3460,   4240,   1652,   1784},
{  2324,  -4148,  -3580,   2676,   1188},
{    12,   2768,  -1168,   4200,   3128},
{ -4244,  -1936,   1448,  -2388,  -3408},
{ -4728,  -2976,   5360,   1048,    252},
{ -3096,  -1932,  -4988,   -280,    392},
{ -4500,  -1060,   -968,   2896,   3736},
};

/**
 * MA predictor (3.2.4)
 */
static const int32_t ma_predictor[2][4][10] = {       /* Q15 */
  {
    { 8421,  9109,  9175,  8965,  9034,  9057,  8765,  8775,  9106,  8673},
    { 7018,  7189,  7638,  7307,  7444,  7379,  7038,  6956,  6930,  6868},
    { 5472,  4990,  5134,  5177,  5246,  5141,  5206,  5095,  4830,  5147},
    { 4056,  3031,  2614,  3024,  2916,  2713,  3309,  3237,  2857,  3473}
  },
  {
    { 7733,  7880,  8188,  8175,  8247,  8490,  8637,  8601,  8359,  7569},
    { 4210,  3031,  2552,  3473,  3876,  3853,  4184,  4154,  3909,  3968},
    { 3214,  1930,  1313,  2143,  2493,  2385,  2755,  2706,  2542,  2919},
    { 3024,  1592,   940,  1631,  1723,  1579,  2034,  2084,  1913,  2601}
  }
};

/**
 * ma_predicot_sum[i] := 1-sum{1}{4}{ma_predictor[k][i]}
 */
static const int16_t ma_predictor_sum[2][10] = {      /* Q15 */
{ 7798,  8447,  8205,  8293,  8126,  8477,  8447,  8703,  9043,  8604},
{14585, 18333, 19772, 17344, 16426, 16459, 15155, 15220, 16043, 15708}
};

/*
-------------------------------------------------------------------------------
          Internal routines
------------------------------------------------------------------------------
*/

#define Q15_BASE (1<<15)
#define FL_Q(a,Q_BASE) ((int32_t)((a)*(Q15_BASE)))
#define Q_FL(a,Q_BASE) (((1.0)*(a))/(Q15_BASE))

#define Q_MUL(a,b,Q_BASE) (((int32_t)(a))*(b)/(Q_BASE))
#define Q_DIV(a,b, Q_BASE) ((int32_t)(a))*(Q_BASE)/(b))


#define FL2FP(a) FL_Q(a, Q15_BASE)
#define FP2FL(a) Q_FL(a, Q15_BASE)
#define FP_MUL(a,b) Q_MUL(a,b, Q15_BASE)
#define FP_DIV(a,b) Q_DIV(a,b, Q15_BASE)
/**
 * \brief pseudo random number generator
 */
static inline uint16_t g729a_random(G729A_Context* ctx)
{
    return ctx->rand_seed = (uint16_t)(31821 * (uint32_t)ctx->rand_seed + 13849 + ctx->rand_seed);
}


/**
 * \brief Decode LP coefficients from L0-L3 
 * \param ctx private data structure
 * \param L0 Switched MA predictor of LSP quantizer
 * \param L1 First stage vector of quantizer
 * \param L2 Second stage lower vector of LSP quantizer
 * \param L3 Second stage higher vector of LSP quantizer
 * \param lsfq Decoded LSP coefficients
 *
 * 3.2.4
 */
static void g729a_lsp_decode(G729A_Context* ctx, int16_t L0, int16_t L1, int16_t L2, int16_t L3, int32_t* lsfq)
{
    int i,j,k;
    int32_t J[2]={FL2FP(0.0012), FL2FP(0.0006)};
    int32_t lq[10];
    int32_t mode_index;
    int32_t diff;
    int* tmp;

//printf("L0:%d  L1:%d L2:%d L3:%d\n",L0,L1,L2,L3);
    /* 3.2.4 Equation 19 */
    for(i=0;i<5; i++)
    {
        lq[i]  =cb_L1[L1][i  ] + cb_L2[L2][i];
        lq[i+5]=cb_L1[L1][i+5] + cb_L3[L3][i];
    }

//printf("buf0: %d %d %d %d %d %d %d %d %d %d\n",lq[0],lq[1],lq[2],lq[3],lq[4],lq[5],lq[6],lq[7],lq[8],lq[9]);

    /* 3.2.4 rearrangement routine */
    for(j=0; j<2; j++)
    {
        for(i=1; i<10; i++)
        {
	    diff=(lq[i-1]-lq[i]+J[j])>>1;
            if(diff>0)
            {
                lq[i-1]-= diff;
                lq[i]  += diff;
            }
        }
    }
    /* 3.2.4, Equation 20 */
    for(i=0; i<10; i++)
    {
        lsfq[i]=FP_MUL(lq[i], ma_predictor_sum[L0][i]);
	for(k=0; k<MA_NP; k++)
	    lsfq[i] += FP_MUL(ctx->lq_prev[k][i], ma_predictor[L0][k][i]);
    }

    /* Rotate lq_prev */
    tmp=ctx->lq_prev[0];
    for(k=1; k<MA_NP; k++)
        ctx->lq_prev[i-1]=ctx->lq_prev[i];
    ctx->lq_prev[MA_NP-1]=tmp;
    for(i=0; i<10; i++)
        ctx->lq_prev[0][i]=lsfq[i];
    ctx->prev_mode=L0;

    /* sorting lsfq in ascending order. double bubble agorithm*/
    for(i=0; i<5; i++)
    {
        int16_t min=lsfq[i];
	int mini=i;
        int16_t max=lsfq[i];
	int maxi=i;
	for(j=i; j< 10-i; j++)
	{
	    if(lsfq[j]>max)
	    {
	        maxi=j;
		max=lsfq[j];
	    }
	    if(lsfq[j]<min)
	    {
	        mini=j;
		min=lsfq[j];
	    }
	}
	FFSWAP(int32_t, lsfq[i], lsfq[mini]);
	FFSWAP(int32_t, lsfq[10-i-1], lsfq[maxi]);
    }


#define LSFQ_MIN FL2FP(0.005)
#define LSFQ_MAX FL2FP(3.135)
#define LSFQ_DIFF_MIN FL2FP(0.0391)
    /* checking for stability */
    for(i=0;i<10; i++)
        lsfq[i] = FFMAX(lsfq[i],LSFQ_MIN); //Is warning required ?

    for(i=0;i<9; i++)
        lsfq[i+1]=FFMAX(lsfq[i+1], lsfq[i]+LSFQ_DIFF_MIN);
    lsfq[9] = FFMIN(lsfq[9],LSFQ_MAX);//Is warning required ?

    //FIXME: fixed-point optimization
    for(i=0;i<10; i++)
        lsfq[i]=FL2FP(cos(FP2FL(lsfq[i])));
}

/**
 * \brief LSP to LP conversion
 * \param ctx private data structure
 * \param q LSP coefficients
 * \param a decoded LP coefficients
 *
 * 3.2.6
 */
static void g729a_lsp2a(G729A_Context* ctx, int* q, int* a)
{
    int f1[7];
    int f2[7];

    int ff1[5];
    int ff2[5];

    f1[0]=0; // f1(-1)
    f1[1]=1; // f1(0)
    f2[0]=0; // f2(-1)
    f2[1]=1; // f2(0)
    for(i=0; i<5; i++)
    {
        f1[i+2]=(f1[i]-FP_MUL(q[2*i],f1[i+1]))<<1;
        f2[i+2]=(f2[i]-FP_MUL(q[2*i+1],f2[i+1]))<<1;
    }

    for(i=0;i<5;i++)
    {
        ff1[i]=f1[i+2]+f1[i+1];
        ff2[i]=f2[i+2]-f2[i+1];
    }

    for(i=0;i<5;i++)
    {
        a[i]=(ff1[i]+ff2[i])>>1;
        a[i+5]=(ff1[4-i]-ff2[4-i])>>1;
    }
    
}

/**
 * \brief interpolate LSP end decode LP for both first and second subframes
 * \param ctx private data structure
 * \param lspq current LSP coefficients
 *
 * 3.2.5 and 3.2.6
 */
static void g729a_decode_lp(G729A_Context* ctx, int* lspq)
{
    int lsp[10];
    int a1[10],a2[10];

    /* LSP values for first subframe (3.2.5)*/
    for(i=0;i<10;i++)
        lsp[i]=(lsqp[i]+ctx->lsp_prev[i])>>1;

    g729a_lsp2a(ctx, lsp, a1);

    /* LSP values for second subframe (3.2.5)*/
    for(i=0;i<10;i++)
        lsp[i]=lsqp[i];

    g729a_lsp2a(ctx, lsp, a2);

    /* saving LSP coefficients for using in next frame */
    for(i=0;i<10;i++)
        lsp_prev[i]=q[i];

}
/*
-------------------------------------------------------------------------------
          API
------------------------------------------------------------------------------
*/
 
/**
 * \brief G.729A decoder initialization
 * \param ctx private data structure
 * \return 0 if success, non-zero otherwise
 */
void* g729a_decoder_init()
{
    G729A_Context* ctx=calloc(1, sizeof(G729A_Context));
    int pitch_max=143;
    int interpol_filt_len=11;
    int frame_size=10;
    int i,k;

    /* Decoder initialization. 4.3, Table 9 */

    /* Pitch gain */
    ctx->betta=0.8;

    /* gain coefficients */
    ctx->g[0]=1.0;
    for(i=1; i<40;i++)
        ctx->g[i]=0.0;

    /* LSP coefficients */
    for(k=0; k<MA_NP; k++)
        ctx->lq_prev[k]=malloc(sizeof(float)*frame_size);

    for(i=0; i<frame_size;i++)
    {
        for(k=0; k<MA_NP; k++)
        {
            ctx->lq_prev[k][i]=FL2FP((i+1)*M_PI/(frame_size+1));
        }
        ctx->lsp_prev[i]=FL2FP(acos(FP2FL(ctx->lq_prev[0][i])));
    }

    ctx->exc_base=calloc(sizeof(short), frame_size*8+pitch_max+interpol_filt_len);
    if(!ctx->exc_base)
        return NULL;

    ctx->exc=ctx->exc_base+pitch_max+interpol_filt_len;
    
    /* random seed initialization (4.4.4) */
    ctx->rand_seed=21845;

    return ctx;
}

/**
 * G.729A decoder uninitialization
 * \param ctx private data structure
 */
void g729a_decoder_uninit(void *context)
{
    G729A_Context* ctx=context;
    int k;

    if(ctx->exc_base) free(ctx->exc_base);
    ctx->exc_base=NULL;
    ctx->exc=NULL;

    if(ctx->q) free(ctx->q);
    ctx->q=NULL;
    for(k=0; k<MA_NP; k++)
    {
        if(ctx->lq_prev[k]) free(ctx->lq_prev[k]);
        ctx->lq_prev[k]=NULL;
    }
}

/**
 * \brief decode one G.729 frame into PCM samples
 * \param serial array if bits (0x81 - 1, 0x7F -0)
 * \param serial_size number of items in array
 * \param out_frame array for output PCM samples
 * \param out_frame_size maximumnumber of elements in output array
 */
int  g729a_decode_frame(void* context, short* serial, int serial_size, short* out_frame, int out_frame_size)
{
    G729A_Context* ctx=context;
    short parm[VECTOR_SIZE];
    int idx=2;
    int i,j;
    int32_t lsp[10];
    int vector_bits[VECTOR_SIZE]={1,7,5,5,8,1,13, 4,3,4,5,13, 4,3,4};

    for(i=0; i<VECTOR_SIZE; i++)
    {
        if(vector_bits[i]>16)
            return 0;
	parm[i]=0;
	for(j=0; j<vector_bits[i]; j++)
        {
            parm[i]<<= 1;
            parm[i] |= serial[idx++]==0x81?1:0;
        }
    }

    g729a_lsp_decode(ctx, parm[0], parm[1], parm[2], parm[3], lsp);
    return 0;
}

/*
---------------------------------------------------------------------------
    Encoder
---------------------------------------------------------------------------
*/
void* g729a_encoder_init()
{
    return NULL;
}
int g729a_encode_frame(void * context, int16_t* data, int ibuflen, int16_t* serial, int obuflen)
{
    return 0;
}
void g729_encoder_uninit(void* context)
{
}
